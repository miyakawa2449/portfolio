{% extends "layout.html" %}

{% block title %}{{ user.handle_name or user.name }} - Portfolio{% endblock %}

{% block head_extra %}
<meta name="description" content="{{ user.tagline or user.introduction[:150] if user.introduction else (user.handle_name or user.name) + 'のポートフォリオページです。' }}">
<meta property="og:title" content="{{ user.handle_name or user.name }} - Portfolio">
<meta property="og:description" content="{{ user.tagline or user.introduction[:150] if user.introduction else (user.handle_name or user.name) + 'のポートフォリオページです。' }}">
<meta property="og:type" content="profile">
<meta property="profile:username" content="{{ user.handle_name or user.name }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile_portfolio.css') }}">
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="d-flex align-items-center mb-4">
                    {% if user.profile_photo %}
                        <img src="{{ url_for('static', filename=user.profile_photo) }}" alt="{{ user.handle_name or user.name }}" class="profile-photo me-4">
                    {% else %}
                        <div class="profile-photo bg-white text-primary d-flex align-items-center justify-content-center me-4" style="font-size: 3rem;">
                            {{ (user.handle_name or user.name)[0].upper() }}
                        </div>
                    {% endif %}
                    <div>
                        <h1 class="mb-1">{{ user.handle_name or user.name }}</h1>
                        {% if user.job_title %}
                            <h2 class="h4 mb-2">{{ user.job_title }}</h2>
                        {% endif %}
                        {% if user.tagline %}
                            <p class="lead mb-0">{{ user.tagline }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Contact Buttons -->
                <div class="mt-4">
                    {% if user.portfolio_email %}
                        <a href="mailto:{{ user.portfolio_email }}" class="contact-btn">
                            <i class="fas fa-envelope me-2"></i>Contact
                        </a>
                    {% endif %}
                    {% if user.linkedin_url %}
                        <a href="{{ user.linkedin_url }}" target="_blank" class="contact-btn" rel="noopener">
                            <i class="fab fa-linkedin me-2"></i>LinkedIn
                        </a>
                    {% endif %}
                    {% if user.github_username %}
                        <a href="https://github.com/{{ user.github_username }}" target="_blank" class="contact-btn" rel="noopener">
                            <i class="fab fa-github me-2"></i>GitHub
                        </a>
                    {% endif %}
                    <!-- Resume PDF - 常に動的生成を表示 -->
                    <a href="{{ url_for('download_resume', user_id=user.id) }}" class="contact-btn">
                        <i class="fas fa-download me-2"></i>Resume PDF
                    </a>
                    {% if user.resume_pdf %}
                        <a href="{{ url_for('static', filename=user.resume_pdf) }}" target="_blank" class="contact-btn">
                            <i class="fas fa-file-pdf me-2"></i>Uploaded Resume
                        </a>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-4">
                <!-- Quick Stats -->
                <div class="row g-3">
                    <div class="col-6">
                        <div class="stat-card">
                            <div class="stat-number">{{ projects|length }}</div>
                            <small>Projects</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card">
                            <div class="stat-number">{{ articles|length }}</div>
                            <small>Articles</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Skills Section -->
    {% if user.skills %}
    <section class="mb-5">
        <h2 class="h3 mb-4">
            <i class="fas fa-code me-2"></i>Technical Skills
        </h2>
        
        <!-- スキルレベル説明 -->
        <div class="mb-4 p-3 bg-light rounded">
            <div class="d-flex align-items-center mb-3">
                <i class="fas fa-info-circle text-primary me-2"></i>
                <small class="text-muted"><strong>スキルレベルについて</strong></small>
            </div>
            <p class="small text-muted mb-3">
                各技術の習熟度を自己評価で数値化し、プロジェクトでの実務経験年数とともに表示しています。
            </p>
            <div class="row">
                <div class="col-md-4 mb-2">
                    <div class="d-flex align-items-center">
                        <div class="skill-level me-2" style="width: 20px;">
                            <div class="skill-level-bar skill-level-advanced" style="width: 100%; height: 4px;"></div>
                        </div>
                        <small class="text-success fw-bold">Expert (85%+)</small>
                    </div>
                </div>
                <div class="col-md-4 mb-2">
                    <div class="d-flex align-items-center">
                        <div class="skill-level me-2" style="width: 20px;">
                            <div class="skill-level-bar skill-level-intermediate" style="width: 100%; height: 4px;"></div>
                        </div>
                        <small class="text-warning fw-bold">Proficient (70-84%)</small>
                    </div>
                </div>
                <div class="col-md-4 mb-2">
                    <div class="d-flex align-items-center">
                        <div class="skill-level me-2" style="width: 20px;">
                            <div class="skill-level-bar skill-level-beginner" style="width: 100%; height: 4px;"></div>
                        </div>
                        <small class="text-primary fw-bold">Developing (~69%)</small>
                    </div>
                </div>
            </div>
        </div>
        {% for category, skills_list in user.skills.items() %}
            <div class="mb-4">
                <h3 class="h5 text-muted mb-3">{{ category }}</h3>
                <div class="row">
                    {% for skill in skills_list %}
                        <div class="col-md-6 mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="fw-semibold">{{ skill.name }}</span>
                                <div class="text-end">
                                    {% if skill.level %}
                                        <small class="text-primary fw-bold">{{ skill.level }}%</small>
                                    {% endif %}
                                    {% if skill.years %}
                                        <small class="text-muted d-block">{{ skill.years }} years</small>
                                    {% endif %}
                                </div>
                            </div>
                            {% if skill.level is defined and skill.level %}
                                <div class="skill-level">
                                    <div class="skill-level-bar skill-level-{{ 'advanced' if skill.level >= 85 else 'intermediate' if skill.level >= 70 else 'beginner' }}" 
                                         style="width: {{ skill.level }}%; display: block;"
                                         data-level="{{ skill.level }}"></div>
                                </div>
                            {% else %}
                                <!-- デバッグ用：レベル情報がない場合 -->
                                <div class="skill-level">
                                    <div class="skill-level-bar" 
                                         style="width: 50%; background: #ff0000 !important; display: block;"
                                         data-level="50">レベル情報なし</div>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </section>
    {% endif %}
    
    <!-- Career History -->
    {% if user.career_history %}
    <section class="mb-5">
        <h2 class="h3 mb-4">
            <i class="fas fa-briefcase me-2"></i>Career History
        </h2>
        <div class="timeline">
            {% for job in user.career_history %}
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <h4 class="h5">{{ job.position }}</h4>
                    <h5 class="h6 text-muted">{{ job.company }} | {{ job.period }}</h5>
                    {% if job.description %}
                        <p>{{ job.description }}</p>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}
    
    <!-- Project Highlights -->
    {% if featured_projects %}
    <section class="mb-5">
        <h2 class="h3 mb-4">
            <i class="fas fa-star me-2"></i>Featured Projects
        </h2>
        <div class="row">
            {% for project in featured_projects[:6] %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card project-highlight h-100">
                        <div class="card-body">
                            <h5 class="card-title">{{ project.title }}</h5>
                            <p class="card-text">{{ project.description[:100] }}...</p>
                            <div class="mb-3">
                                {% for tech in project.technology_list[:3] %}
                                    <span class="badge bg-secondary me-1">{{ tech }}</span>
                                {% endfor %}
                            </div>
                            <div class="d-flex gap-2">
                                {% if project.github_url %}
                                    <a href="{{ project.github_url }}" target="_blank" class="btn btn-sm btn-outline-dark" rel="noopener">
                                        <i class="fab fa-github"></i> Code
                                    </a>
                                {% endif %}
                                {% if project.demo_url_list %}
                                    <a href="{{ project.demo_url_list[0].url }}" target="_blank" class="btn btn-sm btn-outline-primary" rel="noopener">
                                        <i class="fas fa-external-link-alt"></i> Demo
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}
    
    <!-- Education & Certifications -->
    <div class="row">
        {% if user.education %}
        <div class="col-md-6 mb-5">
            <h2 class="h3 mb-4">
                <i class="fas fa-graduation-cap me-2"></i>Education
            </h2>
            {% for edu in user.education %}
                <div class="mb-3">
                    <h5 class="h5 mb-1">{{ edu.degree }} in {{ edu.field }}</h5>
                    <p class="text-muted mb-0">{{ edu.school }} | {{ edu.year }}</p>
                </div>
            {% endfor %}
        </div>
        {% endif %}
        
        {% if user.certifications %}
        <div class="col-md-6 mb-5">
            <h2 class="h3 mb-4">
                <i class="fas fa-certificate me-2"></i>Certifications
            </h2>
            {% for cert in user.certifications %}
                <div class="mb-3">
                    <h5 class="h5 mb-1">{{ cert.name }}</h5>
                    <p class="text-muted mb-0">{{ cert.issuer }} | {{ cert.date }}</p>
                </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
    <!-- 100 Days Challenge Section -->
    {% if challenges %}
    <section class="mb-5">
        <h2 class="h3 mb-4">
            <i class="fas fa-trophy me-2"></i>100 Days Challenge Progress
        </h2>
        <div class="row">
            {% for challenge in challenges %}
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">{{ challenge.name }}</h5>
                            <div class="progress mb-2" style="height: 20px;">
                                <div class="progress-bar bg-gradient" role="progressbar" 
                                     style="width: {{ challenge.progress_percentage }}%"
                                     aria-valuenow="{{ challenge.progress_percentage }}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                    {{ challenge.progress_percentage }}%
                                </div>
                            </div>
                            <p class="text-muted mb-0">
                                Day {{ challenge.days_elapsed }} of {{ challenge.target_days }}
                            </p>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}
    
    <!-- Admin Edit Link -->
    {% if current_user.is_authenticated and (current_user.id == user.id or current_user.role == 'admin') %}
    <div class="text-center mb-5">
        <a href="{{ url_for('admin.edit_portfolio', user_id=user.id) }}" class="btn btn-primary">
            <i class="fas fa-edit me-2"></i>Edit Portfolio
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts_extra %}
<script>
// Animate skill bars on scroll
const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
};

const observer = new IntersectionObserver(function(entries) {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            const skillBars = entry.target.querySelectorAll('.skill-level-bar');
            skillBars.forEach((bar, index) => {
                const targetWidth = bar.getAttribute('data-width') || bar.style.width;
                bar.style.width = '0%';
                setTimeout(() => {
                    bar.style.width = targetWidth;
                }, 200 + (index * 100)); // 順次アニメーション
            });
            observer.unobserve(entry.target);
        }
    });
}, observerOptions);

// スキルバーを即座に表示（アニメーション無効化）
document.addEventListener('DOMContentLoaded', function() {
    console.log('Profile page loaded');
    const skillBars = document.querySelectorAll('.skill-level-bar');
    console.log('Found skill bars:', skillBars.length);
    
    skillBars.forEach((bar, index) => {
        console.log(`Bar ${index}:`, bar.style.width, bar.dataset.level);
        // アニメーション無効化、直接表示
        bar.style.display = 'block';
        bar.style.opacity = '1';
    });
});

// Smooth scroll for internal links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    });
});
</script>
{% endblock %}