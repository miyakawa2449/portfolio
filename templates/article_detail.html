{% extends "layout.html" %}

{% block title %}{{ article.meta_title or article.title }} - {{ site_settings.site_name or 'Tsuyoshi - Python 100 Days' }}{% endblock %}
{% block description %}{{ article.meta_description or (article.summary | truncate(160, True) if article.summary else '') or (article.body | markdown | striptags | truncate(160, True) if article.body else '') or 'プログラミング、テック、ライフスタイルに関する最新記事をお届けします。' }}{% endblock %}
{% block keywords %}{{ article.meta_keywords if article.meta_keywords else 'ブログ,記事,Python,プログラミング' }}{% endblock %}

{% block og_title %}{{ article.meta_title or article.title }}{% endblock %}
{% block og_description %}{{ article.meta_description or (article.summary | truncate(160, True) if article.summary else '') or (article.body | markdown | striptags | truncate(160, True) if article.body else '') or 'プログラミング、テック、ライフスタイルに関する最新記事をお届けします。' }}{% endblock %}
{% block og_type %}article{% endblock %}
{% block og_image %}{% if article.featured_image %}{{ url_for('static', filename=article.featured_image, _external=True) }}{% else %}{{ url_for('static', filename='images/ogp-default.jpg', _external=True) }}{% endif %}{% endblock %}

{% block canonical %}{{ url_for('article_detail', slug=article.slug, _external=True) }}{% endblock %}

{% block content %}
<!-- ヒーローセクション -->
<section class="hero-section py-5">
    <div class="container text-center">
        <!-- パンくずナビ -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb justify-content-center">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('blog') }}" class="text-white text-decoration-none">
                        <i class="fas fa-book me-1"></i> ブログ
                    </a>
                </li>
                {% if article.categories %}
                    {% for category in article.categories %}
                        <li class="breadcrumb-item">
                            <a href="{{ url_for('category_page', slug=category.slug) }}" class="text-white text-decoration-none">
                                {{ category.name }}
                            </a>
                        </li>
                    {% endfor %}
                {% endif %}
                <li class="breadcrumb-item active text-white opacity-75" aria-current="page">
                    {{ article.title[:50] }}...
                </li>
            </ol>
        </nav>

        <!-- カテゴリバッジ -->
        {% if article.categories %}
        <div class="mb-3">
            {% for category in article.categories %}
            <a href="{{ url_for('category_page', slug=category.slug) }}" class="category-badge text-decoration-none me-2">
                {{ category.name }}
            </a>
            {% endfor %}
        </div>
        {% endif %}

        <!-- タイトル -->
        <h1 class="hero-title display-4 fw-bold mb-4">{{ article.title }}</h1>

        <!-- メタ情報 -->
        <div class="d-flex justify-content-center flex-wrap gap-3 mb-4 text-white opacity-75">
            <span>
                <i class="fas fa-calendar-alt me-1"></i>
                {{ article.published_at.strftime('%Y年%m月%d日') if article.published_at else article.created_at.strftime('%Y年%m月%d日') }}
            </span>
            {% if article.author %}
            <span>
                <i class="fas fa-user me-1"></i> {{ article.author.handle_name or article.author.name }}
            </span>
            {% endif %}
            {% if article.challenge %}
            <span>
                <i class="fas fa-trophy me-1"></i> {{ article.challenge.name }}
                {% if article.challenge_day %} - Day {{ article.challenge_day }}{% endif %}
            </span>
            {% endif %}
        </div>
    </div>
</section>

<!-- 記事コンテンツ -->
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- 記事本文 -->
            <article class="card shadow-sm border-0 mb-5">
                {% if article.featured_image %}
                <img src="{{ url_for('static', filename=article.featured_image) }}" 
                     class="card-img-top" 
                     alt="{{ article.featured_image_alt or article.title }}"
                     style="height: 400px; object-fit: cover;">
                {% endif %}
                
                <div class="card-body p-4 p-lg-5">
                    {% if article.summary %}
                    <div class="alert alert-info mb-4">
                        <h5 class="alert-heading mb-3">
                            <i class="fas fa-info-circle me-2"></i>この記事の概要
                        </h5>
                        <p class="mb-0">{{ article.summary }}</p>
                    </div>
                    {% endif %}

                    <div class="article-content">
                        {{ article.body | markdown | safe }}
                    </div>

                    <!-- 関連プロジェクト -->
                    {% if article.related_projects %}
                    <div class="section-divider"></div>
                    <section class="related-projects mb-4">
                        <h3 class="h4 mb-3">
                            <i class="fas fa-folder-open text-primary me-2"></i>関連プロジェクト
                        </h3>
                        <div class="row g-3">
                            {% for project in article.related_projects %}
                            <div class="col-md-6">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h5 class="card-title">{{ project.title }}</h5>
                                        {% if project.description %}
                                        <p class="card-text small">{{ project.description[:100] }}...</p>
                                        {% endif %}
                                        <div class="d-flex gap-2 mt-3">
                                            {% if project.github_url %}
                                            <a href="{{ project.github_url }}" target="_blank" class="btn btn-outline-dark btn-sm">
                                                <i class="fab fa-github me-1"></i> Code
                                            </a>
                                            {% endif %}
                                            {% if project.demo_url_list %}
                                            <a href="{{ project.demo_url_list[0].url }}" target="_blank" class="btn btn-primary btn-sm">
                                                <i class="fas fa-external-link-alt me-1"></i> Demo
                                            </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </section>
                    {% endif %}

                    <!-- タグ -->
                    {% if article.tags %}
                    <div class="tags mb-4">
                        <h5 class="mb-3">
                            <i class="fas fa-tags text-primary me-2"></i>タグ
                        </h5>
                        <div class="d-flex flex-wrap gap-2">
                            {% for tag in article.tags %}
                            <span class="badge bg-light text-dark border">{{ tag }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </article>

            <!-- 著者情報 -->
            {% if article.author %}
            <div class="card shadow-sm border-0 mb-5">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <div class="bg-gradient-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                 style="width: 60px; height: 60px; font-size: 24px; font-weight: bold;">
                                {{ (article.author.handle_name or article.author.name)[0].upper() }}
                            </div>
                        </div>
                        <div>
                            <h4 class="mb-1">{{ article.author.handle_name or article.author.name }}</h4>
                            <p class="text-muted mb-0">{{ article.author.bio or 'プログラマー・データサイエンティスト' }}</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- ナビゲーション -->
            <div class="card shadow-sm border-0 mb-5">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <a href="{{ url_for('blog') }}" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-2"></i>記事一覧に戻る
                        </a>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary" onclick="window.print()">
                                <i class="fas fa-print me-2"></i>印刷
                            </button>
                            <button class="btn btn-outline-info" onclick="copyUrl()">
                                <i class="fas fa-share me-2"></i>シェア
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- コメントセクション -->
{% if comments %}
<section class="py-5 bg-light">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <h3 class="mb-4">
                    <i class="fas fa-comments text-primary me-2"></i>コメント ({{ comments|length }})
                </h3>
                
                {% for comment in comments %}
                <div class="card mb-3 shadow-sm border-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h5 class="mb-1">{{ comment.name }}</h5>
                                <small class="text-muted">{{ comment.created_at.strftime('%Y年%m月%d日 %H:%M') }}</small>
                            </div>
                            {% if comment.email %}
                            <small class="text-muted">{{ comment.email }}</small>
                            {% endif %}
                        </div>
                        <p class="mb-0">{{ comment.content }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- コメント投稿フォーム -->
<section class="py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-gradient-primary text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-comment-dots me-2"></i>コメントを投稿
                        </h4>
                    </div>
                    <div class="card-body p-4">
                        <form method="POST" action="{{ url_for('add_comment', article_id=article.id) }}">
                            {{ comment_form.hidden_tag() }}
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ comment_form.name.label(class="form-label") }}
                                        {{ comment_form.name(class="form-control") }}
                                        {% for error in comment_form.name.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ comment_form.email.label(class="form-label") }}
                                        {{ comment_form.email(class="form-control") }}
                                        {% for error in comment_form.email.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                {{ comment_form.content.label(class="form-label") }}
                                {{ comment_form.content(class="form-control", rows="4", placeholder="あなたのコメントをここに入力してください...") }}
                                {% for error in comment_form.content.errors %}
                                    <div class="text-danger small">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="text-end">
                                {{ comment_form.submit(class="btn btn-primary btn-lg") }}
                            </div>
                        </form>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                コメントは承認制です。不適切な内容は掲載されません。
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// URLコピー機能
function copyUrl() {
    navigator.clipboard.writeText(window.location.href).then(function() {
        // Bootstrap toastを表示
        showToast('URLをクリップボードにコピーしました！');
    });
}

// トースト表示機能
function showToast(message) {
    // 動的にtoast要素を作成
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div class="toast" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <strong class="me-auto">
                    <i class="fas fa-check-circle me-2"></i>成功
                </strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    // Toast container作成（存在しない場合）
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '1060';
        document.body.appendChild(toastContainer);
    }
    
    // Toast要素を追加
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    // Toast表示
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: 3000
    });
    toast.show();
    
    // Toast削除（アニメーション後）
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}

// スムーススクロール
document.addEventListener('DOMContentLoaded', function() {
    // 記事内のリンクにスムーススクロールを適用
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
    
    // 読み取り時間の計算（目安）
    const articleContent = document.querySelector('.article-content');
    if (articleContent) {
        const wordCount = articleContent.textContent.split(/\s+/).length;
        const readingTime = Math.ceil(wordCount / 200); // 200語/分として計算
        
        // 読み取り時間の表示（メタ情報に追加）
        const metaInfo = document.querySelector('.hero-section .d-flex');
        if (metaInfo) {
            const readingTimeSpan = document.createElement('span');
            readingTimeSpan.innerHTML = '<i class="fas fa-clock me-1"></i>約' + readingTime + '分で読めます';
            metaInfo.appendChild(readingTimeSpan);
        }
    }
});
</script>
{% endblock %}