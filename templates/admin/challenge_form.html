{% extends "admin/layout.html" %}

{% block page_title %}
{% if challenge %}チャレンジ編集{% else %}新しいチャレンジ{% endif %}
{% endblock %}

{% block breadcrumb %}
<li><a href="{{ url_for('admin.dashboard') }}">ホーム</a></li>
<li><a href="{{ url_for('admin.challenges') }}">チャレンジ管理</a></li>
<li class="active">{% if challenge %}編集{% else %}新規作成{% endif %}</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    {% if challenge %}
                        <i class="fas fa-edit"></i> チャレンジ編集: {{ challenge.name }}
                    {% else %}
                        <i class="fas fa-plus"></i> 新しいチャレンジ
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token_value() }}"/>
                    <!-- 基本情報 -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="name" class="form-label">チャレンジ名 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   value="{{ challenge.name if challenge else '' }}" required>
                        </div>
                        <div class="col-md-4">
                            <label for="slug" class="form-label">スラッグ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="slug" name="slug" 
                                   value="{{ challenge.slug if challenge else '' }}" required>
                            <div class="form-text">URL用の識別子（英数字とハイフンのみ）</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">説明</label>
                        <textarea class="form-control" id="description" name="description" rows="3">{{ challenge.description if challenge else '' }}</textarea>
                    </div>

                    <!-- 期間設定 -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="start_date" class="form-label">開始日 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="start_date" name="start_date" 
                                   value="{{ challenge.start_date.strftime('%Y-%m-%d') if challenge and challenge.start_date else '' }}" required>
                        </div>
                        <div class="col-md-4">
                            <label for="end_date" class="form-label">終了日</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" 
                                   value="{{ challenge.end_date.strftime('%Y-%m-%d') if challenge and challenge.end_date else '' }}">
                            <div class="form-text">空白の場合は進行中として扱われます</div>
                        </div>
                        <div class="col-md-4">
                            <label for="target_days" class="form-label">目標日数</label>
                            <input type="number" class="form-control" id="target_days" name="target_days" 
                                   value="{{ challenge.target_days if challenge else 100 }}" min="1" max="1000">
                        </div>
                    </div>

                    <!-- 進捗の手動調整 -->
                    {% if challenge and not challenge.end_date %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6><i class="fas fa-calendar-check"></i> 進捗の手動調整</h6>
                            <div class="alert alert-info">
                                <small>
                                    現在の進捗: <strong>{{ challenge.days_elapsed }}日目</strong> (自動計算)
                                    {% if challenge.manual_days %}
                                    <br>手動調整済み: {{ challenge.manual_adjustment_date.strftime('%Y/%m/%d') }}に{{ challenge.manual_days }}日目に設定
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="manual_days" class="form-label">手動で日数を設定</label>
                            <input type="number" class="form-control" id="manual_days" name="manual_days" 
                                   min="1" max="{{ challenge.target_days }}"
                                   placeholder="例: 15">
                            <div class="form-text">設定すると、翌日から自動でカウントアップします</div>
                        </div>
                        <div class="col-md-6">
                            {% if challenge.manual_days %}
                            <div class="pt-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="clear_manual" name="clear_manual">
                                    <label class="form-check-label" for="clear_manual">
                                        手動調整をクリアして自動計算に戻す
                                    </label>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- 状態設定 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_active" name="is_active" 
                                       {% if challenge and challenge.is_active %}checked{% endif %}>
                                <label class="form-check-label" for="is_active">
                                    アクティブなチャレンジ
                                </label>
                                <div class="form-text">アクティブなチャレンジはランディングページに表示されます（1つまで）</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="display_order" class="form-label">表示順序</label>
                            <input type="number" class="form-control" id="display_order" name="display_order" 
                                   value="{{ challenge.display_order if challenge else 0 }}" min="0">
                            <div class="form-text">小さい数字ほど上に表示されます</div>
                        </div>
                    </div>

                    <!-- GitHubリポジトリ -->
                    <div class="mb-4">
                        <label class="form-label">GitHubリポジトリ</label>
                        <div id="repos-container">
                            {% if challenge and challenge.github_repositories %}
                                {% for repo in challenge.github_repositories %}
                                <div class="repo-item border rounded p-3 mb-3">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <input type="text" class="form-control" name="repo_names[]" 
                                                   placeholder="リポジトリ名" value="{{ repo.name }}">
                                        </div>
                                        <div class="col-md-6">
                                            <input type="url" class="form-control" name="repo_urls[]" 
                                                   placeholder="https://github.com/username/repo" value="{{ repo.url }}">
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button" class="btn btn-outline-danger w-100" onclick="removeRepo(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-12">
                                            <input type="text" class="form-control" name="repo_descriptions[]" 
                                                   placeholder="説明（任意）" value="{{ repo.description or '' }}">
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <button type="button" class="btn btn-outline-primary" onclick="addRepo()">
                            <i class="fas fa-plus"></i> リポジトリを追加
                        </button>
                    </div>

                    <!-- 送信ボタン -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('admin.challenges') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> 戻る
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> 
                            {% if challenge %}更新{% else %}作成{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- プレビュー -->
        {% if challenge %}
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0"><i class="fas fa-eye"></i> プレビュー</h6>
            </div>
            <div class="card-body">
                <h6>{{ challenge.name }}</h6>
                {% if challenge.description %}
                <p class="small">{{ challenge.description }}</p>
                {% endif %}
                
                <div class="progress mb-2" style="height: 20px;">
                    <div class="progress-bar 
                        {% if challenge.status == 'completed' %}bg-success
                        {% elif challenge.status == 'active' %}bg-primary
                        {% else %}bg-secondary{% endif %}" 
                         role="progressbar" 
                         style="width: {{ challenge.progress_percentage }}%">
                        {{ challenge.days_elapsed }}/{{ challenge.target_days }}
                    </div>
                </div>
                
                <small class="text-muted">
                    {{ challenge.start_date.strftime('%Y年%m月%d日') }} ～ 
                    {% if challenge.end_date %}
                        {{ challenge.end_date.strftime('%Y年%m月%d日') }}
                    {% else %}
                        進行中
                    {% endif %}
                </small>
                
                {% if challenge.github_repositories %}
                <div class="mt-2">
                    <small class="text-muted d-block">GitHubリポジトリ:</small>
                    {% for repo in challenge.github_repositories %}
                    <a href="{{ repo.url }}" target="_blank" class="btn btn-sm btn-outline-primary me-1 mb-1">
                        {{ repo.name }}
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- ヘルプ -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0"><i class="fas fa-question-circle"></i> ヘルプ</h6>
            </div>
            <div class="card-body">
                <h6>チャレンジについて</h6>
                <ul class="small">
                    <li>100日間の学習チャレンジを管理します</li>
                    <li>アクティブなチャレンジは1つまでです</li>
                    <li>進捗は開始日からの経過日数で自動計算されます</li>
                    <li>複数のGitHubリポジトリを設定できます</li>
                </ul>
                
                <h6 class="mt-3">スラッグについて</h6>
                <p class="small">URL用の識別子です。英数字とハイフン（-）のみ使用可能です。例：python-100-days-1</p>
            </div>
        </div>
    </div>
</div>

<script>
// リポジトリ追加
function addRepo() {
    const container = document.getElementById('repos-container');
    const div = document.createElement('div');
    div.className = 'repo-item border rounded p-3 mb-3';
    div.innerHTML = `
        <div class="row">
            <div class="col-md-4">
                <input type="text" class="form-control" name="repo_names[]" placeholder="リポジトリ名">
            </div>
            <div class="col-md-6">
                <input type="url" class="form-control" name="repo_urls[]" placeholder="https://github.com/username/repo">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-outline-danger w-100" onclick="removeRepo(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-12">
                <input type="text" class="form-control" name="repo_descriptions[]" placeholder="説明（任意）">
            </div>
        </div>
    `;
    container.appendChild(div);
}

// リポジトリ削除
function removeRepo(button) {
    button.closest('.repo-item').remove();
}

// 名前からスラッグを自動生成
document.getElementById('name').addEventListener('input', function() {
    const name = this.value;
    const slug = name.toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim('-');
    
    if (!document.getElementById('slug').value || 
        document.getElementById('slug').dataset.auto !== 'false') {
        document.getElementById('slug').value = slug;
    }
});

// スラッグが手動編集されたかを追跡
document.getElementById('slug').addEventListener('input', function() {
    this.dataset.auto = 'false';
});
</script>
{% endblock %}